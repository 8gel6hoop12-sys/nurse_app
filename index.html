<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>看護アシスタントを起動中…</title>
<style>
:root{--bg:#fff8fb;--text:#2e2a2f;--line:#e9c7d5;--accent:#f59bc0}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
.card{width:min(720px,94vw);border:1px solid var(--line);border-radius:14px;background:#fff;padding:20px;box-shadow:0 6px 28px rgba(0,0,0,.06)}
h1{margin:0 0 8px;font-size:20px}
p{margin:.5em 0 0;line-height:1.6}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);cursor:pointer;background:#f7cfe3;font-weight:700}
.btn.primary{background:var(--accent);color:#fff;border:0}
.small{color:#6b5a65;font-size:13px}
.log{margin-top:10px;padding:10px;border:1px dashed var(--line);border-radius:10px;white-space:pre-wrap;background:#fff}
.badge{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:#fff2d7;color:#8f5e00;font-size:12px}
.hidden{display:none}
hr{border:0;border-top:1px solid var(--line);margin:14px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>看護アシスタント <span id="status" class="badge">ローカル確認中…</span></h1>
    <p>このページは <strong>GitHub Pages 用の入口</strong>です。PC内で動いているアプリ（<code>nurse_server.py</code>）に自動で接続します。</p>
    <div class="row">
      <button id="btnRetry" class="btn">再チェック</button>
      <button id="btnOpen" class="btn primary">ローカルを開く</button>
      <button id="btnHow" class="btn">起動手順</button>
    </div>
    <div id="howto" class="hidden">
      <hr>
      <p><b>はじめての方へ</b></p>
      <ol>
        <li>PCで <code>pip install flask</code> を実行</li>
        <li>リポ内で <code>python nurse_server.py --port 8008</code> を実行</li>
        <li>このページを再読み込み（または「再チェック」）</li>
      </ol>
      <p class="small">※ ポートを変えたい場合は、このURLに <code>?port=8010</code> のように付けてください。</p>
    </div>
    <div id="log" class="log small"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const log = (m) => { const el=$("#log"); el.textContent += (m+"\n"); el.scrollTop=el.scrollHeight; };
const q = new URLSearchParams(location.search);
const PORT = Number(q.get("port")||"8008")||8008;
const LOCAL = `http://127.0.0.1:${PORT}`;
const HEALTH = `${LOCAL}/ai/health`;

async function checkAndOpen(autoRedirect){
  $("#status").textContent = "ローカル確認中…";
  $("#status").style.background = "#fff2d7"; $("#status").style.color="#8f5e00";
  log(`fetch: ${HEALTH}`);
  try{
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), 2000);
    const r = await fetch(HEALTH, {signal: ctrl.signal});
    clearTimeout(timer);
    if(r.ok){
      const js = await r.json().catch(()=>({}));
      $("#status").textContent = "接続OK";
      $("#status").style.background = "#e6f6ec"; $("#status").style.color="#1b7a3f";
      log(`OK: model=${js.model||"?"}, provider=${js.provider||"?"}`);
      if(autoRedirect){
        log(`→ 自動で ${LOCAL}/ へ移動します`);
        location.href = `${LOCAL}/?tab=${q.get("tab")||"assessment"}`;
      }
      return true;
    }else{
      $("#status").textContent = "接続NG";
      $("#status").style.background = "#ffe3e6"; $("#status").style.color="#8f1d28";
      log(`NG: status ${r.status}`);
      return false;
    }
  }catch(e){
    $("#status").textContent = "接続NG";
    $("#status").style.background = "#ffe3e6"; $("#status").style.color="#8f1d28";
    log(`NG: ${e}`);
    return false;
  }
}

$("#btnRetry").addEventListener("click", ()=>checkAndOpen(false));
$("#btnOpen").addEventListener("click", ()=>{ location.href = `${LOCAL}/?${location.search.slice(1)}`; });
$("#btnHow").addEventListener("click", ()=>$("#howto").classList.toggle("hidden"));
checkAndOpen(true);
let tries = 0;
const iv = setInterval(async ()=>{
  if(tries++>=6) return clearInterval(iv);
  const ok = await checkAndOpen(true);
  if(ok) clearInterval(iv);
}, 5000);
</script>
</body>
</html>
