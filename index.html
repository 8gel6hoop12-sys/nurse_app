<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>看護アシスタント | 入口</title>
<style>
:root{--bg:#fff7fb;--panel:#fff;--line:#ead0dc;--accent:#f59bc0;--accent2:#f7cfe3;--text:#2e2a2f}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif}
.wrap{max-width:1100px;margin:28px auto;padding:20px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:22px 20px}
h1{font-size:48px;margin:6px 0 14px}
.lead{font-size:22px;line-height:1.7;margin:10px 0 24px}
.small{color:#6b5a64;font-size:14px}
.btn{display:inline-flex;align-items:center;gap:10px;background:var(--accent);color:#fff;border:0;border-radius:14px;padding:16px 24px;font-weight:800;font-size:22px;cursor:pointer}
.btn:hover{filter:brightness(.98)}
.row{margin-top:18px;border-top:1px dashed var(--line);padding-top:14px}
.badge{display:inline-block;padding:2px 10px;border-radius:999px;font-size:13px;margin-left:8px}
.badge.ok{background:#e6f6ec;color:#1b7a3f}
.badge.ng{background:#ffe2e6;color:#8f1d28}
pre{white-space:pre-wrap;background:#fff;border:1px dashed var(--line);padding:10px;border-radius:12px;height:220px;overflow:auto}
.center{display:flex;gap:12px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>いつもお疲れさまです</h1>
    <p class="lead">ふだんの流れはそのままに、入力と確認がすっと終わるよう整えています。<br>
    記録・画像は端末内で完結します。外には出しません。安心してお使いください。</p>

    <div class="center">
      <button id="btnStart" class="btn">▶ はじめる</button>
      <span id="stat" class="badge ng">接続NG</span>
    </div>

    <div class="row small">
      <div id="hint">起動リンクを開きました。反応が無ければ下の「初回セットアップ」を一度だけ実施してください。</div>
    </div>

    <div class="row">
      <details>
        <summary class="small">初回セットアップ（配布側が1回だけ）</summary>
        <ol class="small">
          <li>このフォルダごと配布端末へ配置（zipでもOK）。</li>
          <li><code>deploy.ps1</code> をダブルクリック（ユーザ権限でOK）。</li>
          <li>以後はログイン時に自動でサーバが起動します。看護師はこのページから「はじめる」を押すだけ。</li>
        </ol>
        <p class="small">※ 自動起動済みであれば 127.0.0.1 と通信して自動遷移します。</p>
      </details>
    </div>

    <div class="row small">
      <strong>状況</strong>
      <pre id="log"></pre>
    </div>
  </div>
</div>

<script>
const LOG = document.getElementById('log');
const STAT = document.getElementById('stat');
const HINT = document.getElementById('hint');

function log(s){ LOG.textContent += s + "\n"; LOG.scrollTop = LOG.scrollHeight; }
async function checkOnce(){
  try{
    const r = await fetch('http://127.0.0.1:8787/ai/health', {cache:'no-store',mode:'no-cors'});
    // mode:no-cors だとステータス取れないので到達＝OK扱い
    STAT.textContent = '接続OK'; STAT.className='badge ok';
    return true;
  }catch(e){
    STAT.textContent = '接続NG'; STAT.className='badge ng';
    return false;
  }
}
async function tryOpenUI(){
  const ok = await checkOnce();
  if(ok){
    log('OK: ローカルに到達。UIへ移動します。');
    location.href = 'http://127.0.0.1:8787/';
  }else{
    log('NG: ローカル未起動。起動を待機します…');
    // 10秒間、1秒ごとに再チェック
    for(let i=0;i<10;i++){
      await new Promise(r=>setTimeout(r,1000));
      if(await checkOnce()){ location.href='http://127.0.0.1:8787/'; return; }
    }
    log('NG: まだ起動していません。配布側の初回セットアップをご確認ください。');
  }
}

document.getElementById('btnStart').addEventListener('click', tryOpenUI);

// ページを開いたら自動で軽くチェック
tryOpenUI();
</script>
</body>
</html>
