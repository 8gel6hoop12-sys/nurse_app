<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>看護アシスタント | 入口</title>
<style>
:root{--bg:#fff7fb;--panel:#fff;--line:#ead0dc;--accent:#f59bc0;--text:#2e2a2f}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif}
.wrap{max-width:1100px;margin:28px auto;padding:20px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:24px}
h1{font-size:46px;margin:6px 0 14px}
.lead{font-size:20px;line-height:1.9;margin:8px 0 22px}
.btn{display:inline-flex;align-items:center;gap:10px;background:var(--accent);color:#fff;border:0;border-radius:14px;padding:16px 24px;font-weight:800;font-size:22px;cursor:pointer}
.btn:hover{filter:brightness(.98)}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;margin-left:8px}
.badge.ok{background:#e6f6ec;color:#1b7a3f}
.badge.ng{background:#ffe2e6;color:#8f1d28}
.small{color:#6b5a64;font-size:14px}
hr{border:none;border-top:1px dashed var(--line);margin:18px 0}
.links{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
a.dl{display:inline-block;padding:12px 16px;border:1px solid var(--line);border-radius:10px;background:#fff;text-decoration:none;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">いつもお疲れさまです</h1>
    <p id="msg" class="lead">
      ここからサッと起動できます。記録や画像は端末内だけで完結し、外へは出しません。
    </p>

    <button id="btnStart" class="btn">▶ はじめる</button>
    <span id="stat" class="badge ng">接続NG</span>

    <div class="links" style="margin-top:16px">
      <a class="dl" id="dlSetupWin">Windows 初回セットアップ（.bat）</a>
      <a class="dl" id="dlStartWin">Windows 起動ボタン（.bat）</a>
      <a class="dl" id="dlSetupMac">macOS 初回セットアップ（.sh）</a>
      <a class="dl" id="dlStartMac">macOS 起動ボタン（.sh）</a>
      <a class="dl" id="dlNanda">NANDA Excel（任意）</a>
    </div>

    <hr>
    <div class="small" id="hint">
      ［はじめる］は <code>http://127.0.0.1:8787/</code> に接続できればアプリ画面を開きます。<br>
      初回は OS に合わせて「初回セットアップ」を保存 → ダブルクリックしてください。
    </div>
  </div>
</div>

<script>
const LOCAL = "http://127.0.0.1:8787";
const STAT = document.getElementById('stat');
function setOK(ok){ STAT.textContent = ok?'接続OK':'接続NG'; STAT.className = 'badge ' + (ok?'ok':'ng'); }

async function ping(){
  try{
    await fetch(LOCAL + '/ai/health',{mode:'no-cors',cache:'no-store'});
    setOK(true); return true;
  }catch(e){ setOK(false); return false; }
}

// 汎用ダウンロード（サーバにあれば取得/なければローカル生成）
async function smartDownload(filename, serverPath, fallbackText) {
  // 1) まずサーバに取りに行く
  try{
    const r = await fetch(LOCAL + serverPath, {cache:'no-store'});
    if (r.ok) {
      const blob = await r.blob();
      triggerSave(blob, filename);
      return;
    }
  }catch(e){ /* サーバに届かない → フォールバック */ }
  // 2) フォールバック（ブラウザ内で生成）
  const blob = new Blob([fallbackText], {type: guessMime(filename)});
  triggerSave(blob, filename);
}

function guessMime(fn){
  if (fn.endsWith('.bat')) return 'application/octet-stream';
  if (fn.endsWith('.sh'))  return 'application/x-sh';
  if (fn.endsWith('.txt')) return 'text/plain;charset=utf-8';
  if (fn.endsWith('.json'))return 'application/json;charset=utf-8';
  if (fn.endsWith('.xlsx'))return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
  return 'application/octet-stream';
}

function triggerSave(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}

// ----- スクリプト内容（フォールバック用） -----
const BAT_SETUP =
`@echo off
setlocal
cd /d "%~dp0"
cd ..
echo [1/4] venv 準備…
if not exist ".venv" (
  py -3 -m venv .venv || (echo venv作成失敗 & pause & exit /b 1)
)
echo [2/4] pip アップグレード…
".venv\\Scripts\\python.exe" -m pip install -U pip
echo [3/4] 依存インストール…
".venv\\Scripts\\python.exe" -m pip install -r requirements.txt
echo [4/4] サーバ起動…
start "" "${LOCAL}/"
".venv\\Scripts\\python.exe" nurse_server.py --port 8787
pause
`;

const BAT_START =
`@echo off
setlocal
cd /d "%~dp0"
cd ..
if not exist ".venv\\Scripts\\python.exe" (
  echo 初回セットアップが必要です。setup_win.bat を先に実行してください。
  pause
  exit /b 1
)
start "" "${LOCAL}/"
".venv\\Scripts\\python.exe" nurse_server.py --port 8787
`;

const SH_SETUP =
`#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."
python3 -m venv .venv
./.venv/bin/python -m pip install -U pip
./.venv/bin/python -m pip install -r requirements.txt
open "${LOCAL}/" 2>/dev/null || true
./.venv/bin/python nurse_server.py --port 8787
`;

const SH_START =
`#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."
if [ ! -x ".venv/bin/python" ]; then
  echo "初回セットアップが必要です。setup_mac.sh を先に実行してください。"
  exit 1
fi
open "${LOCAL}/" 2>/dev/null || true
./.venv/bin/python nurse_server.py --port 8787
`;

// クリックでスマートDL
document.getElementById('dlSetupWin').onclick = ()=> smartDownload('setup_win.bat','/files/setup_win.bat', BAT_SETUP);
document.getElementById('dlStartWin').onclick = ()=> smartDownload('start_win.bat','/files/start_win.bat', BAT_START);
document.getElementById('dlSetupMac').onclick = ()=> smartDownload('setup_mac.sh','/files/setup_mac.sh', SH_SETUP);
document.getElementById('dlStartMac').onclick = ()=> smartDownload('start_mac.sh','/files/start_mac.sh', SH_START);
// NANDA はサーバにないと作れないため、到達できる時だけ
document.getElementById('dlNanda').onclick = async ()=>{
  try{
    const r = await fetch(LOCAL + '/nanda.xlsx', {cache:'no-store'});
    if (!r.ok) throw new Error('not ok');
    const blob = await r.blob();
    triggerSave(blob, 'nanda_db.xlsx');
  }catch(e){ alert('サーバに接続できません。後で［はじめる］から起動後に再度ダウンロードしてください。'); }
};

// はじめる
document.getElementById('btnStart').addEventListener('click', async ()=>{
  const ok = await ping();
  if(ok){ location.href = LOCAL + '/nurse_ui.html'; }
  else { alert('アプリが起動していません。\n「初回セットアップ」または「起動ボタン」を実行してください。'); }
});

// 画面表示時に接続状態だけ見る
(async ()=>{ for(let i=0;i<2;i++){ await ping(); await new Promise(r=>setTimeout(r,400)); } })();
</script>
</body>
</html>
